# Documentation

Here is some documentation regarding the STAMINA/Storm codebase that will help you get started understanding how stuff works in the STAMINA/STORM codebase, including the build process, the namespace and code heirarchy, etc.

## Build process

### Dependencies

#### Debian, Ubuntu, etc. via `apt`

```sh
# Storm dependencies
sudo apt-get install -y build-essential git cmake libboost-all-dev libcln-dev libgmp-dev libginac-dev automake libglpk-dev libhwloc-dev libz3-dev libxerces-c-dev libeigen3-dev
# STAMINA-specific dependencies (GUI-only)
sudo apt install libkf5xmlgui-dev libkf5textwidgets-dev libkf5kio-dev libkf5texteditor-dev qtbase5-dev qtdeclarative5-dev libqt5svg5-dev libkf5i18n-dev libkf5coreaddons-dev extra-cmake-modules
```

#### Arch, Manjaro, etc. via `pacman`

```sh
# Storm dependencies
sudo pacman -Syu base-devel git cmake boost-libs clang
# STAMINA-specific dependencies (GUI-only)
sudo pacman -Syu kde-sdk-meta # meta-package to install kf5, qt5, ecm, etc.
```

#### MacOS via `brew`

```sh
# Storm dependencies
brew install automake cmake boost gmp glpk hwloc z3 xerces-c
# Alternatively you can just
brew tap moves-rwth/storm && brew install stormchecker
# STAMINA-specific dependencies (GUI-only)
# TODO: KF5 brew tap
```

### Building

STAMINA uses [CMake](https://cmake.org/), an open-source build tool for C++ which integrates well with STAMINA's dependencies (Storm, Qt, KF5, etc...). You can use the CMake GUI, or the `cmake` CLI tool. We recommend creating a `build` folder for all of the output files. On Linux or MacOS, CMake produces a GNU makefile, which can be invoked using `make`. There is also the `cmake --build` command, which should be more OS-agnostic.

The `cmake` executable should take the working directory of `CMakeLists.txt` as its first argument. So, if you create a `build` directory under the root directory, and then invoke CMake from within that build directory, you would do something like this:

```sh
mkdir build && cd build
cmake .. $CMAKE_ARGUMENTS
```

To pass in parameters to CMake, use `-DPARAM_NAME=Value` for `PARAM_NAME`. During the invocation of CMake, the following options are available:

- `STAMINA_DEBUG`: Compile the STAMINA executables with debug information which can be used with `gdb` or other debuggers.
- `BUILD_GUI`: Compile the STAMINA GUI, not just the STAMINA CLI.
- `STORM_PATH`: The location where the compiled version of Storm is. This is *not* the location of `libstorm.so` or `libstorm.dylib`, it is the parent directory of that! This variable is **generally required**, but can be omitted if Storm's shared object files are installed in your system's library paths (`LD_LIBRARY_PATH` on Linux I think).

### What gets built

`CMakeLists.txt` defines the building of 3 specific different compiled object files:

1. `libstamina.so`/`libstamina.dylib` (Probably called `stamina.dll` or `libstamina.dll` on Windows but I've never gotten it to compile on Windows): This is a shared-object where most of the heavy lifting occurs. All of the STAMINA algorithms and data types and work exist in this object.
2. `sstamina`: This is the CLI entry point into STAMINA. It uses GNU Argp for argument parsing. It links against `libstamina.so`.
3. `xstamina`: This is the GUI for STAMINA. It links against `libstamina.so`.

### Packaging and CPack

STAMINA uses CPack, the CMake Packager, to create distributable packages for Linux. The file `StaminaCPackConfig.cmake` contains the information to create different packages. Currently Debian packages `.deb` are the most supported.

## Class and Namespace Heirarchy

All of STAMINA's classes, types, objects, etc, exist within the `stamina` namespace. The folder structure matches the namespace heirarchy almost exactly. Any additions to the codebase should continue this. So, if you have something in the `stamina::builder::threads` namespace, the file will be in `src/stamina/builder/threads`. Here is a short breakdown of each of the namespaces:

- `stamina`: Main STAMINA namespace
	- `builder`: Anything related to model building and transition matrix creation.
		- `threads`: Any classes related to threads or threading with the exception of threaded builders
	- `core`: The "core" classes, such as `StaminaModelChecker` and `StaminaMessages`
	- `gui`: Anything related to the GUI
		- `addons`: Custom widgets
			- `highlighter`: Syntax highlighter for the PRISM language
		- `ui`: Autogenerated header files from QtDesigner `*.ui` files.
	- `priority`: Methods of prioritizing states in state exploration
	- `threadsafe`: Reimplementation of some Storm classes to be thread-safe
	- `util`: Classes which are "utils" or tools used by other classes.

### Class Heirarchy

The following heirarchy shows each of STAMINA's classes and a description of what they do:

- namespace `stamina`
	- `Stamina`: this class provides a simple entry point into STAMINA, used by both the GUI and CLI. It provides the simple `run()` method to run STAMINA, and can be constructed with a model file name or not.
	- namespace `builder`
		- `StainaModelBuilder`: Base class for all model builders. Utilizes `storm::generator::PrismNextStateGenerator`
			+ `StaminaReExploringModelBuilder`: The version of `StaminaModelBuilder` which implements the STAMINA 2.0 algorithm.
			+ `StaminaIterativeModelBuilder`: The version of `StaminaModelBuilder` which implements the STAMINA 2.5 algorithm.
			+ `StaminaPriorityModelBuilder`: The version of `StaminaModelBuilder` that implements the STAMINA 3.0 algorithm.
		- `ExplicitTruncatedModelBuilder`: Depricated
		- `ProbabilityState`: A class that contains probability information about a state.
			+ `ProbabilityStatePair`: Contains a ProbabilityState and a `CompressedState &` (a.k.a., `storm::storage::BitVector &`), which are the actual state values (see `core::StateSpaceInformation`)
			+ `ProbabilityStatePairComparison`: Custom comparator for `ProbabilityStatePair`s based on the embedded `ProbabilityState`
			+ `ProbabilityStatePairPointerComparison`: Like `ProbabilityStatePairComparison` but for pointers. (Could simplify this)
		- `StateAndTransitions`: Not a class, but a file which contains several helper structs and classes for holding data:
			+ `StaminaTransitionInfo`: Contains information about a transition, including origin state, destination state, and rate/probability.
			+ `StaminaTransitionInfoComparison`: Overloads `operator()` for `StaminaTransitionInfo`
			+ `StaminaStateAndThreadIndex`: Holds state and thread indecies for threaded model builders
			+ `StateAndProbability`: State values and `deltaPi` (change in probability)
			+ `threads::StaminaStateIndexAndThread` (defined outside of `threads` folder): Used to hold state index, state values and thread index
		- namespace `threads`:
			+ `BaseThread`: Base class from which all thread-classes inherit
			+ `ControlThread`: Manages state ownership and cross exploration
			+ `ExplorationThread`: Thread which asynchronously explores the state space
				* `IterativeExplorationThread`: Version of `ExplorationThread` for STAMINA 2.5 algorithm.
	- namespace `core`
		- `Options`: Class with static members for options STAMINA uses
		- `StaminaMessages`: Class with static methods for logging information
		- `StaminaModelChecker`: Does the model checking via Storm
		- `StateSpaceInformation`: Lets you get information about state values given the state space.
	- namespace `gui`
		- `About`: The about window
		- `FindReplace`: Widget which lets you find and replace text in a `addons::CodeEditor`
		- `GuiWorkerThread`: Thread (`QThread` subclass) which runs STAMINA in a non-blocking manner for the GUI
		- `MainWindow`: The main window
		- `MessageBridge`: Communicates with `StaminaMessages` to put logs in the log viewer on the main window
		- `Preferences`: The preferences window
		- `PropertyWizard`: A window that allows you to build a property without knowing CSL syntax.
		- namespace `addons`
			- `CodeEditor`: Syntax-highlighting enabled code editor with line numbers
			- `LineNumberArea`: QWidget which paints line numbers to the left of the text
			- namespace `highlighter`
				- `ColorSchemes`: List of static `ColorScheme` instances. Currently only light and dark mode.
					+ `ColorScheme` a syntax highlighting scheme.
				- `Highlighter`: Syntax highlighter which highlights text in a `CodeEditor`
					- `PrismHighlighter`: Syntax highlighter for PRISM files specifically
		- namespace `ui`: Autogenerated-by-UIC (Qt's UI compiler) UI code. Handled by MOC in CMakeLists. Names correspond to windows or widgets within windows that can be shown by xSTAMINA
			+ `ui_MainWindow`
				+ `ui_FindReplace`
			+ `ui_About`
			+ `ui_Preferences`
			+ `ui_PropertyWizard`
	- namepsace `priority`
		- `StatePriority`: Pure virtual abstract class that creates a priority metric on the state passed in
			- `EventStatePriority`: A class derived from `StatePriority` which optimizes for rare and common events
	- namespace `threadsafe`
		- TODO
	- namespace `util`
		- `ModelModify`: Creates modified properties and reads model. Maybe should rename. The name is a holdover from when we created a temp file with an absorbing variable.
		- `StateIndexArray`: Datastructure which holds states and their indecies, and allows lookup by index.
		- `StateMemoryPool`: a memory pool where `ProbabilityState`s are allocated.

